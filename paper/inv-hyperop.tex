In this section, we use \emph{countdown} to define division, logarithm,
iterated logarithm, and then the inverse hyperoperation hierarchy.
We then modify the inverse hyperoperations to sketch an inverse 
Ackermann hierarchy.

\subsection{The Inverse Hyperoperations, including Division, Log, and Log*}

\begin{defn} \label{defn: inv-hyperop}
	The inverse hyperoperations, written $a\angle{n}b$, are defined as follows:
	\begin{equation}
	a\angle{n}b \triangleq \begin{cases}
	b - 1 & \hspace{-10pt} \quad \text{ if } n = 0 \\
	\cdt{a\angle{n-1}}{a_n}(b) & \hspace{-10pt} \quad \text{ if } n \ge 1
	\end{cases}
	\ \ \quad \text{ where } \ a_n = \begin{cases}
	a & \hspace{-10pt}\text{ if } n = 1 \\
	0 & \hspace{-10pt}\text{ if } n = 2 \\
	1 & \hspace{-10pt}\text{ if } n \ge 3
	\end{cases}
	\end{equation}
	Note that we use $a\angle{n{-}1}$ in a Curried style to denote the single-variable function $\lambda b.a\angle{n{-}1}b$.
\begin{lstlisting}
Fixpoint inv_hyperop a n b :=
  match n with
  | 0 => b - 1
  | S n' =>
    countdown_to (hyperop_init a n') (inv_hyperop a n') b
  end.
\end{lstlisting}
\end{defn}
\hide{
Continuing with the notion of upper-inverses we have used thus far,
we aim for the \emph{ceiling} of division and $\log$ on real numbers, $\left\lceil b/a \right\rceil$ and $\left\lceil \log_ab \right\rceil$. The iterated logarithm is formally defined as the minimum number of times $\log$ needs to be iteratively 
applied to the input for the result to become less than or equal to $1$. 
Thus it is natural to define it using \emph{countdown}.

\begin{defn} \label{defn: divc} \label{defn: logc} \label{defn: log*}
\[
\divc(a, b) \! \triangleq \! \cdt{\left(\lambda b. (b{-}a)\right)}{0}(b) \quad
\logc(a, b) \! \triangleq \! \cdt{\left(\lambda b. \divc(a, b)\right)}{1}(b) \quad
\log^*(a, b) \! \triangleq \! \cdt{\left(\lambda b. \logc(a, b)\right)}{1}(b)
%\begin{array}{c}
%\divc(a, b) \triangleq \cdt{\left(\lambda b. (b-a)\right)}{0}(b) \qquad
%\logc(a, b) \triangleq \cdt{\left(\lambda b. \divc(a, b)\right)}{1}(b) \\
%\log^*(a, b) \triangleq \cdt{\left(\lambda b. \logc(a, b)\right)}{1}(b)
%\end{array}
\]
\begin{lstlisting}
Definition divc a b := countdown_to 0 (fun n => n - a) b.
Definition logc a b := countdown_to 1 (divc a) b.
Definition logstar a b := countdown_to 1 (logc a) b.
\end{lstlisting}\vspace*{-0.5\baselineskip}
\end{defn}
}%end hide
\hide{Proving $\forall a, b \ge 1,~\divc(a, b) = \left\lceil b/a \right\rceil$ serves
to prove that all three definitions are correct, since that statement implies 
the correctness of  $\logc$, which in turn implies the correctness of $\log^*$. We will prove this in \cref{blah},
together with the correctness of the entire hyperoperation hierarchy.
}

We now prove that $a\angle{n}$ is the inverse to $a[n]$.  First, note that $\forall a.~ a\angle{0}\in {\color{red}\contract_0}$. Then:
\begin{lem}
$a\angle{1}b = b - a$.
\end{lem}
\begin{proof}
Since $a\angle{0} \in {\color{red}\contract_1} \subset \contract_{a}$, \cref{thm: cdt-recursion} applies.
\begin{equation*}
a\angle{1}b \quad = \quad \cdt{\left(a\angle{0}\right)}{a}(b) \quad = \quad \begin{cases}
0 & \text{ if } b\le a \\ 1 + a\angle{1}(b - 1) & \text{ if } b\ge a+1 \end{cases} \\
\end{equation*}
Then, $a\angle{1}b = b - a$ by induction on $b$.
\end{proof}
\begin{col} \label{col: inv-hyperop-1-contr1}
$\forall a \ge 1, a\angle{1} \in \contract_1$.
\end{col}
\hide{\begin{col} \label{col: inv-hyperop-234}
{\color{magenta}$\forall a \in \mathbb{N}$}:
 {\color{blue} For all $a \in \mathbb{N}$},
\begin{enumerate}
	\item If $a\ge 1$, $a\angle{2}b = \divc(a, b) \ \forall b$.
	\item If $a\ge 2$, $a\angle{3}b = \logc(a, b) \ \forall b$ and $a\angle{4}b = \logstarc(a, b) \ \forall b$.
\end{enumerate}
\end{col}}%end hide
%Now we are ready to prove the correctness of the inverse hyperoperations.
Note that $a\angle{n}b$ is a total function, but that its behavior is not used in practice for $a = 0$ when $n \ge 2$ and for $a=1$ when $n \ge 3$.  For the values
we do care about, we have:
\begin{thm} \label{thm: inv-hyperop-correct}
When $n\le 1$, $n \le 2 \wedge a\ge 1$, or $a\ge 2$, then 
$a\angle{n} = \left(a[n]\right)^{-1}_+$.
\end{thm}
\begin{proof}
Let $a_0 = a$, $a_1 = 0$, $a_n = 1 \ \forall n\ge 2$. Define
\begin{equation*}
P(n) \triangleq  \left(a[n] \in \repeatable_{a_n}\right)\ \text{ and } \
Q(n) \triangleq  \left(a\angle{n} = \left(a[n]\right)^{-1}_+ \right)
\end{equation*}
Our goals are $Q(0), Q(1) \ \forall a$, $Q(2) \ \forall a\ge 1$ and $Q(n) \ \forall n \ \forall a\ge 2$. Note that for all $n$, $a\angle{n+1} = \cdt{a\angle{n}}{a_n}$ and $a[n+1] = \rf{a[n]}{a_n}\ $. By \cref{thm: cdt-inv-rf},
\begin{align}
P(n) \to Q(n) \to Q(n+1) \ \forall n \ \forall a \label{eq: tmp-induction-1} \\
(a_n\ge 1) \to P(n) \to P(n+1) \ \forall n \label{eq: tmp-induction-2}
\end{align}
For all $a$, $P(0) \equiv \left(\lambda b.(b+1)\in \repeatable_a \right)$ and
\begin{equation*}
Q(0) \equiv \left(a\angle{0} = \left(a[0]\right)^{-1}_+\right) \equiv \left(b-1\le c \iff b\le c+1 \ \forall b, c \right)
\end{equation*}
, which are both trivial. By \eqref{eq: tmp-induction-1}, $Q(1)$ also holds, which completes our first goal. Now suppose $a\ge 1$, $a_0 = a\ge 1$, so $P(1)$ holds by $P(0)$ and \eqref{eq: tmp-induction-2}. By $Q(1)$ and \eqref{eq: tmp-induction-1}, $Q(2)$ also holds, which completes the second goal.

Suppose $a\ge 2$ and consider the third goal, by \eqref{eq: tmp-induction-1} and $Q(0)$, it suffices to show $P(n)$ for all $n$. By \eqref{eq: tmp-induction-2} and the fact $a_n\ge 1 \ \forall n\neq 1$, it remains to show $P(2)$, which is equivalent to
\begin{equation*}
a[2]\in \repeatable_0 \iff (ab < ac \ \forall b < c) \wedge (ab \ge b+1 \ \forall b\ge 1)
\end{equation*}
, which is trivial for $a\ge 2$. By induction, the third goal and the proof are complete.
\end{proof}
%With this theorem, we have proved the correctness of $\divc$, $\logc$ and $\log^*$, as well as the whole inverse hyperoperation hierarchy.
\begin{rem}
Three early hyperoperations are $a[2]b = ab$, $a[3]b = a^b$ and $a[4]b = \ ^ba$, so by \cref{thm: inv-hyperop-correct}, we can define their inverses $\left\lceil b/a \right\rceil$, $\left\lceil \log_a b \right\rceil$, and $\log^*_a b$ as $a\angle{2}b$, $a\angle{3}b$, and $a\angle{4}b$.  
Note that the functions $\log_a b$, and $\log^*_a b$ are not in the Coq Standard Library.
\end{rem}
\hide{
\begin{col}
	$\forall a \in \mathbb{N}$:
	\begin{enumerate}
		\item If $a\ge 1$, $\divc(a, b) = \left\lceil \frac{b}{a} \right\rceil$.
		\item If $a\ge 2$, $\logc(a, b) = \left\lceil \log_ab \right\rceil $ and $\logstarc(a, b) = \log^*_ab$.
	\end{enumerate}
\end{col}
\begin{proof}
	The result follows from \cref{col: inv-hyperop-234}, \cref{thm: inv-hyperop-correct} and the first few expansions of the hyperoperation hierarchy: $a[2]b = ab$, $a[3]b = a^b$ and $a[4]b = \ ^ba$.
\end{proof}

\begin{rem}
	\Cref{thm: cdt-recursion} leads to useful recursive formulas for $\divc$, $\logc$ and $\logstarc$:
	\begin{align*}
	\divc(a, b) & = 1 + \divc(a, b - a) & \text{ if } b > 0 &\text{, and } 0 \text{ otherwise}. \\
	\logc(a, b) & = 1 + \logc\left(a, \left\lceil b/a \right\rceil\right) & \text{ if } b > 1 &\text{, and } 0 \text{ otherwise}. \\
	\logstarc(a, b) & = 1 + \divc(a, \left\lceil \log_ab \right\rceil) & \text{ if } b > 1 &\text{, and } 0 \text{ otherwise}.
	\end{align*}
\end{rem}
}

\subsection{The Inverse Ackermann hierarchy}

% NEW METHOD FOR INVERSE ACKERMANN
Using countdown, we can effectively build an inverse Ackermann hierarchy, where each level $\alpha_i$ is the inverse of the level $\Ack_i$. Since for each $n$, $\Ack_{i+1} = \rf{\Ack_i}{\Ack_i(1)}$, the recursive rule $\alpha_{i+1} \triangleq \cdt{\alpha_i}{\Ack_i(1)}$ seems tempting. However, that rule stills depends on $\Ack_i$, rather than only on $\alpha_i$, which makes it ineffective. Instead, we reexamine the inverse relationship: suppose $\alpha_i = \big(\Ack_i\big)^{-1}_+$ and $\alpha_{i+1} = \big(A_{i+1}\big)^{-1}_+$. {\color{magenta}Then for all $n, m$}, $A_{i+1}(m) = \big(A_i\big)^{(m)}\big(A_i(1)\big)$, so
\begin{equation} \label{eq: inv-ack-hier-derive}
\alpha_{i+1}(n)\le m \iff n\le \big(A_i\big)^{(m+1)}(1) \iff \big(\alpha_i\big)^{(m+1)}(n) \le 1
\end{equation}
This is equivalent to $\alpha_{i+1}(n) = \min\big\{m : \big( \alpha_i \big)^{(m+1)}(n)\le 1\big\}$, or $\alpha_{i+1}(n) = \cdt{\alpha_i}{1}\big(\alpha_i(n)\big)$. We can thus define the following inverse Ackermann hierarchy.
\begin{defn} \label{defn: inv-ack-hier}
	The \emph{inverse Ackermann hierarchy} $\{\alpha_i\}_{i=0}^{n}$ is a series of functions $\mathbb{N}\to \mathbb{N}$ such that
\begin{equation*}
	\alpha_i = \begin{cases}
	\lambda n.(n - 1) & \text{if } i = 0
	\\ \big(\cdt{\alpha_{i-1}}{1}\big)\circ \alpha_{i-1} & \text{if } i\ge 1 \end{cases}
\end{equation*}
\end{defn}
Their correctness have already been established in \eqref{eq: inv-ack-hier-derive}. We can then provide another computation for the inverse Ackermann function.
\begin{thm} \label{thm: inv-ack-hier-correct}
	%For all $n, k$, $n\le \Ack(k, k) \!\!\iff \!\! \alpha_k(n)\le k$. Thus
	$\alpha(n) = \min\big\{k : \alpha_k(n)\le k \big\}$.
\end{thm}
The following Coq-complied recursive function can compute $\alpha$ effectively.
\begin{defn} \label{defn: inv-ack-worker}
	The \emph{inverse Ackermann worker} is a function $\W\alpha\ : (\mathbb{N}\to \mathbb{N}) \times \mathbb{N}^3\to \mathbb{N}$ such that for all $n, k, b\in \mathbb{N}$ and $f:\mathbb{N}\to \mathbb{N}$:
	\begin{equation} \label{eq: inv-ack-worker-recursion}
	\W\alpha(f, n, k, b) = \begin{cases}
	k & \text{if } b = 0 \vee n\le k \\ \W\alpha(\cdt{f}{1}\circ f , \cdt{f}{1}(n), k+1, b-1) & \text{if } b \ge 1 \wedge n \ge k+1
	\end{cases}
	\end{equation}
\end{defn}
{\color{magenta}The function $\W\alpha$ takes a function $f$ and pretends it was the first level of the inverse Ackermann hierarchy. It then keeps composing $\cdt{f}{1}\ $ to $f$, supposedly arrives at the $\text{m}^{\text{th}}$-level in the hierarchy after the $\text{m}^{\text{th}}$-recursive step, until the budget $b$ is exhausted or $n\le k$, and will output $k$.}

{\color{blue} Observe that when given the arguments $\big(\alpha_i, \alpha_i(n), i, b\big)$ such that $\alpha_i(n) > i$ and $b > i$, $\W\alpha$ will take on arguments $\big(\alpha_{i+1}, \alpha_{i+1}(n), i+1, b-1\big)$ at the next recursive call. Thus if initial arguments involve $\alpha_0$, $\alpha_0(n)$, $0$ and a sufficient budget $b$, $\W\alpha$ will recursively move through the chain $\big\{\alpha_i(n)\big\}$ and terminate at a point $k$ where $\alpha_k(n)\le k$.}
The following theorem formalizes a setting that for $\W\alpha$ to work.
\begin{thm} \label{thm: inv-ack-worker-correct}
	$\W\alpha\big(\alpha_0, \alpha_0(n), 0, n\big) = \alpha(n)$.
\end{thm}
Here, we give $\W\alpha$ a budget of $n$ and prove that it is sufficient for $\W\alpha$ to arrive at the correct value for $\alpha(n)$. We start with the following lemma.
\begin{lem} \label{lem: inv-ack-worker-intermediate}
	For all $n, b, k$ such that $k+1\le \min\big\{b, \alpha_k(n)\big\}$, \begin{equation*}
	\W\alpha\big(\alpha_0, \alpha_0(n), 0, b\big) = \W\alpha\big(\alpha_{k+1}, \alpha_{k+1}(n), k+1, b-k-1\big)
	\end{equation*}
\end{lem}
\begin{proof}
	 We prove $P(k) \ \forall k$ by induction, where
	 \begin{equation*}
	 \begin{aligned}
	 P(k) \triangleq \forall n, b \ \ & (\alpha_k(n)\ge k+1) \to (b\ge k+1)\\ & \to \W\alpha\big(\alpha_0, \alpha_0(n), 0, b\big) = \W\alpha\big(\alpha_{k+1}, \alpha_{k+1}(n), k+1, b-k-1\big)
	 \end{aligned}
	 \end{equation*}
	\begin{enumerate}[leftmargin=*]
		\item \emph{Base case}. $ \W\alpha\big(\alpha_0, \alpha_0(n), 0, b\big) = \W\alpha\big(\cdt{\big(\alpha_0}{1}\big)\circ \alpha_0, \cdt{\alpha_0}{1}\big(\alpha_0(n)\big), 1, b - 1\big) $ by
		\eqref{eq: inv-ack-worker-recursion} with $b\ge 1$ and $\alpha_0(n)\le 1$. Since $\alpha_1 = \big(\cdt{\alpha_0}{1}\big) \circ \alpha_0$ per \cref{defn: inv-ack-hier}, $P(0)$ holds.
		
		\item \emph{Inductive step.} Suppose $\alpha_{k+1}(n)\ge k+2$ and $b\ge k+2$. Then $\alpha_k(n)\ge k+1$ and $b\ge k+1$, so $P(k)$ applies. It suffices to show
		\begin{equation*}
		\W\alpha\big(\alpha_{k+1}, \alpha_{k+1}(n), k+1, b-k-1\big)
		= \W\alpha\big(\alpha_{k+2}, \alpha_{k+2}(n), k+2, b-k-2\big)
		\end{equation*}
		Per \cref{defn: inv-ack-hier}, $\alpha_{k+2} = \big(\cdt{\alpha_{k+1}}{1}\big)\circ \alpha_{k+1}$, so this is just \eqref{eq: inv-ack-worker-recursion} with $b - k - 1\ge 1$ and $\alpha_{k+1}(n)\ge k+2$, so $P(k+1)$ holds. The proof is complete by induction.\vspace*{-\baselineskip}
	\end{enumerate}
\end{proof}
%Next, a lemma connecting the value of $\W\alpha(f, n, k , b)$ and $k$, which is important because the recursive rule alone does not tell how the value of $\W\alpha$ changes at each recursive step.
%\begin{lem}
%	For all $f, n, k, b$, $\W\alpha\big(f, n, k, b\big) \ge k$.
%\end{lem}
%\begin{proof}
%	Fix $n$, if $k \ge n$, equality occurs. Consider only $k\le n$, using backwards induction, suppose $\W\alpha\big(f, n, k, b\big) \ge k \ \forall f, b$ for some $1\le k\le n$. Now fix $f, b$ and consider $\W\alpha\big(f, n, k-1, b\big)$. If $b = 0$, equality occurs. Otherwise, $\W\alpha\big(f, n, k-1, b\big) = \W\alpha\big(f, n, k, b\big) \ge k \ge k-1$. The proof is complete.
%\end{proof}
Now we are ready to prove the correctness of the inverse Ackermann worker.
\begin{proof}[Proof of \Cref{thm: inv-ack-worker-correct}]
	Since the sequence $\big\{\alpha_k(n)\big\}_{k=1}^{\infty}$ decreases while $\{k\}_{k=1}^{\infty}$ increases to infinity, there exists $m \triangleq \min\big\{k : \alpha_k(n) \le k \} = \alpha(n)$. Note that $m\le n$ since $\alpha_n(n)\le n$.
	If $m = 0$, $\alpha_0(n)\le 0 \!\! \implies \!\! \alpha_0(n) = 0$. Thus $\W\alpha\big(\alpha_0, \alpha_0(n), 0, n\big) = 0 = m$. If $m \ge 1$, \cref{lem: inv-ack-worker-intermediate} implies
	$$ \W\alpha\big(\alpha_0, \alpha_0(n), 0, n\big) = \W\alpha\big(\alpha_m, \alpha_m(n), m, n - m\big) = m $$
	where the last equality follows from the recursive rule.
\end{proof}


% OLD METHOD FOR INVERSE ACKERMANN

%Using the Ackermann kludge from \cref{sec: overview}, we sketch a method to find the inverse Ackermann function from the inverse hyperoperations.
%\begin{thm} \label{thm: inv-hyperop-inv-ack}
%	For all $n, k$, $n\le \Ack(k, k) \iff 2\angle{k}(n+3)\le k+3$.
%\end{thm}
%\begin{proof}
%	$n\le \Ack(k, k) \iff n\le 2[k](k+3) - 3$. Now $2[k]$ is an expansion by \cref{thm: inv-hyperop-correct}'s proof, so $2[k](k+3) \ge k+3\ge 3$, so  $n\le 2[k](k+3) - 3 \iff n+3 \le 2[k](k+3)\iff 2\angle{k}(n+3)\le k+3$, again by \cref{thm: inv-hyperop-correct}.
%\end{proof}
%\Cref{thm: inv-hyperop-inv-ack} allows a simple method to compute the Inverse Ackermann function, based on the \emph{budget} idea in \emph{countdown worker}.
%\begin{defn} \label{defn: inv-ack-worker}
%	The \emph{inverse Ackermann worker} of $f$ is a function $\W\alpha\ : \mathbb{N}^4\to \mathbb{N}$ such that for all $n, k, b\in \mathbb{N}$ and $f:\mathbb{N}\to \mathbb{N}$:
%	$$ \W\alpha(f, n, k, b) = \begin{cases}
%	k - 3 & \text{if } b = 0 \vee f(n)\le k+3 \\ \W\alpha(\cdt{f}{a_k}\ , n, k+1, b-1) & \text{if } b \ge 1 \wedge f(n) > k+3
%	\end{cases} $$
%	where $a_0 = 2$, $a_1 = 0$ and $a_k = 1 \ \forall k\ge 2$.
%\end{defn}
%The function $\W\alpha$ takes a function $f$ and pretends it was the first level of the inverse hyperoperation hierarchy. It then keeps applying countdown to $f$, supposedly arrives at the $\text{m}^{\text{th}}$-level at the $\text{m}^{\text{th}}$-recursive step, until the budget $b$ is exhausted or $f(n)\le k+3$, i.e. \emph{early stopping}, and will output $k$. If at the beginning $k=3$ and $f = 2\angle{0}$, the early stopping condition becomes $2\angle{k}n \le k+3$, which when replace $n$ by $n+3$ gives what we need in \cref{thm: inv-hyperop-inv-ack}.
%The inverse Ackermann function can be defined as follows.
%\begin{thm} For all $n$, we have $\alpha(n) = \W\alpha(\lambda m.(m - 1), n+3, 3, n)$.
%\end{thm}